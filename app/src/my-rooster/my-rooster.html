<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/webcomponentsjs/webcomponents.js"></script>

<link rel='import' href='fullcalendar-styles.html' />
<link rel="import" href="../../bower_components/nebula-dialog/nebula-dialog.html">

<script src='../../bower_components/jquery/dist/jquery.min.js'></script>
<script src='../../bower_components/moment/min/moment.min.js'></script>
<script src='../../bower_components/fullcalendar/dist/fullcalendar.js'></script>

<dom-module id="my-rooster">
    <template>
        <style include="fullcalendar-styles">

            .lesInfo{
                min-width: 150px;
                max-width: 400px;
                word-wrap: break-word;
                background-color: white;
                padding: 10px;
                border-radius: 15px;
                -moz-border-radius: 15px;
            }
            .blue{
                background-color: #0066cc;
                color: white;
            }
            .red{
                background-color: #990000;
                color: white;
            }
            h3{
                margin: 5px 5px 5px 5px;
            }

        </style>
        <div id="calendar"></div>
        <nebula-dialog id="dialog">
            <div class="lesInfo">
                <h3>Informatie over vandaag</h3>
                Vak: [[vakNaam]] <br>
                Docent: [[vakDocent]]<br>
                Klascode: [[klasCode]]<br>
                Begint om: [[start]]<br>
                Eindigt om: [[end]]<br><br>
                <template is="dom-if" if="{{is_docent()}}">
                    <paper-button class="blue" on-tap="bekijkPresentie">Bekijk presentie</paper-button></template>
                <template is="dom-if" if="[[is_student()]]">
                    <paper-checkbox on-tap="presentie_rooster" class="set_presentierooster" value$="[[uuid]]">
                        Present
                    </paper-checkbox>
                </template>
                <paper-button class="red" on-tap="closeModal">Sluit</paper-button>
            </div>
        </nebula-dialog>

        <iron-ajax url="/rooster" handle-as="json" auto on-response="handleResp"></iron-ajax>

    </template>

    <script>
        Polymer({

            is: 'my-rooster',

            properties: {
                vakNaam: {},
                vakDocent: {},
                klasCode: {},
                start: {},
                end: {},
                uuid: {
                    type: String,
                    notify: true
                }

            },
            listeners: {
                'request': 'ajaxRequest',
                'response': 'ajaxResponse'
            },
            presentie_rooster: function (e) {
                $.ajax({
                    type: 'POST',
                    url: '/rooster/les/edit',
                    data: JSON.stringify({ "uuid": e.target.value, "verwachtAfwezig": e.target.checked,"student": this.nummer }), // or JSON.stringify ({name: 'jonas'}),
//                                    success: function(data) { alert('data: ' + data); },
                    contentType: "application/json",
                    dataType: 'json'
                });
            },
            is_student: function(){
              return this.rol == 'student';
            },
            is_docent: function(){
                return this.rol == 'docent';
            },
            bekijkPresentie: function() {
                console.log("trigger");
                window.location.assign("/#/systeem/presentieles");
                var app = document.querySelector('my-app'); // stuur aan my-app de uuid door. Die daarna de presentielijst refreshed.
                app.uuid = les.uuid;
                this.closeModal();
            },

            closeModal: function() {
                this.$.dialog.close();
            },
            ajaxRequest: function() {
                $("#loader1").css("display", "block");
            },
            ajaxResponse: function() {
                $("#loader1").css("display", "none");
            },

            handleResp: function(request) {
                var self = this;
                console.log(this.is_student());

                $(this.$.calendar).fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,basicWeek,basicDay'
                    },
                    editable: false,
                    eventLimit: true,
                    defaultView: 'basicWeek',
                    events: request.detail.response,

                    eventClick: function(calEvent, jsEvent, view) {
                        les = calEvent;
                        self.$.dialog.show();
                        self.vakNaam = calEvent.title;
                        self.vakDocent = calEvent.docent.email;
                        self.klasCode = calEvent.klas.klascode;
                        self.start = calEvent._start._i;
                        self.end = calEvent._end._i;
                        self.uuid = calEvent.uuid;
                    }
                });
            }


        });
    </script>
</dom-module>