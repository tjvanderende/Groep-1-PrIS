<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<script src="../../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../../bower_components/js-url/url.min.js"></script>
<link rel="import"href="../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import"href="../../bower_components/iron-data-table/data-table-column.html">
<link rel="import"href="../../bower_components/iron-data-table/data-table-row.html">
<dom-module id="my-presentieles">
    <template restamp="true">
        <style>
            :host {
                display: block;
            }

            :root {
                --paper-input-container-focus-color: #1a9fd9; /* kind of blue */
            }

            span {
                @apply(--paper-font-body1);
            }

            .toast-button {
                text-transform: none;
                color: white; /* white tekst */
                background: #1a9fd9; /* kind of blue */
                --paper-button-ink-color: #00567B; /* kind of dark blue */
            }

            .my-title {
                font-size: 20px;
                color: blue;
                border-bottom: 1px solid red; /* a red line */
                padding-bottom: 2px; /* space above the border line */
            }
            .rood{
                --paper-checkbox-unchecked-background-color: red;
            }
            .voornaam {
                min-width: 100px;
                text-align: left;
            }

            .achternaam {
                min-width: 100px;
                text-align: left;
            }

            .groepid-header {
                min-width: 100px;
                text-align: left;
            }

            .groepid {
                min-width: 100px;
            }

            .my-button {
                width: 100%; /* full width */
                color: white; /* white tekst */
                background: #1a9fd9; /* kind of blue */
                --paper-button-ink-color: #00567B; /* kind of dark blue */
                margin-top: 5px; /* enlarge thet default */
                margin-left: 0px; /* reduce the default */
            }
        </style>

        <div class="my-title">Overzicht Meldingen</div>
        <!--<iron-ajax url="/meldingen" last-response="{{data}}" auto></iron-ajax>-->
        <iron-ajax id="ajax_studenten_ophalen" method="POST" auto url="/rooster/les?uuid=[[uuid]]" handle-as="json" on-response="hresponse"></iron-ajax>
        <iron-data-table items="[[data]]" selection-enabled>
            <data-table-column name="Naam">
                <template>[[item.voornaam]][[item.achternaam]]</template>
            </data-table-column>
            <data-table-column name="Studentnr">
                <template>
                    <span>[[item.nummer]]</span>
                </template>
            </data-table-column>
            <data-table-column name="Presentie">
                <template is="dom-if" if="[[item.presentie.verwachtAfwezig]]">
                    <paper-checkbox id="set_presentie"
                                    class="my-check"
                                    checked="[[item.presentie.aanwezig]]" value="[[item.nummer]]" >
                    </paper-checkbox>
                </template>

            </data-table-column>


        </iron-data-table>
    </template>

    <script>

        (function () {
            Polymer({
                is: 'my-presentieles',

                properties: {
                    uuid: {
                        type: String,
                        value: $.url().split("=")[1]
                    },
                    _c_studenten: {
                        type: Array, /* array<student-info>: student-info = {id, firstName, lastName, sameGroup}
                         array is constant groepnr is changable */
                    },
                    data: {
                        type: Object,
                    },
                    c_rol: {
                        type: String,
                    },
                    c_username: {
                        type: String,
                    },
                    c_les: {
                        type: String,
                    },
                    c_visible: {
                        type: Boolean, /* true when element is the active visible item */
                        value: false,
                        observer: '_initializing', /* wordt ook aangeroepen bijwisseling van true naar false.
                         regel in de functie dat er niets gebeurd
                         als c_visible false is */
                    },
                },
                hresponse: function(request) {
                    this.c_visible = false;
                    console.log(request.detail.response);
                    this.data= request.detail.response;
                },
                ready: function () {
                    console.log(this.c_visible);
                    uuid = $.url().split("=")[1];
                    this.async(function () {
                        if (this.$$("#set_presentie")) {
                            this.$$('#set_presentie').addEventListener('iron-change', function (e) {
                                $.ajax({
                                    type: 'POST',
                                    url: '/rooster/les/edit',
                                    data: JSON.stringify({ "uuid": uuid, "afwezigheid": e.target.checked,"student": e.target.value }), // or JSON.stringify ({name: 'jonas'}),
//                                    success: function(data) { alert('data: ' + data); },
                                    contentType: "application/json",
                                    dataType: 'json'
                                });
                            });
                        }
                    }, 50);
                },
                _go_home: function () {
                    var lApp = document.querySelector('my-app');  //het polymer element <my-app>
                    var lAppRouter = lApp.$.approuter;            // het html-element <app-route> met id=approuter
                    lAppRouter.data = {page: ""};                   // vul het data attribute met de homepage url
                },

                _initializing: function () {
                    if (this.c_visible) {    /* zodra zichtbaar geworden haal info op van server */
//                        location.reload();
//                        console.log("_ophalen_lesinfo_request_handler");
                        this.$.ajax_studenten_ophalen.contentType="application/json";
                        this.$.ajax_studenten_ophalen.body={
                        };
                        this.$.ajax_studenten_ophalen.generateRequest();
                    }
                },

                _studenten_ophalen_les_request_handler: function () {
                    console.log("_studenten_ophalen_les_request_handler user=" + this.c_username);
                    this.$.ajax_medestudenten_ophalen.contentType = "application/json";
                    this.$.ajax_medestudenten_ophalen.body = {
                        "username": this.c_username
//                        moet les ophalen met les id en
                    };
                    this.$.ajax_medestudenten_ophalen.generateRequest();
                },

                _medestudenten_ophalen_response_handler: function (request) {
                    console.log("_mededestudenten_ophalen_response_handler aantal studenten=" + request.detail.response.length);
                    this._c_studenten = request.detail.response;
                },

                _medestudenten_opslaan_request_handler: function () {
                    console.log("_medestudenten_opslaan_request_handler user=" + this.c_username);
                    this.$.ajax_medestudenten_opslaan.contentType = "application/json";
                    this.$.ajax_medestudenten_opslaan.body = {
                        "username": this.c_username,
                        "groupMembers": this._c_studenten
                    };
                    this.$.ajax_medestudenten_opslaan.generateRequest();
                },

                _medestudenten_opslaan_response_handler: function (request) {
                    console.log("_mededestudenten_opslaan_response_handler errorcode=" + request.detail.response.errorcode);
                    this._go_home();
                    /* verlaat de pagina en ga terug naar home page */
                },

                _toast_clicked: function (e) {
                    var lToast = this.$.toast_invalid_aanroep;        // meldt ongeldige aanroep
                    lToast.toggle();
                },

            });
        })();
    </script>
</dom-module>
